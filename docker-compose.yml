# Used in GitHub CI.
# Don't use this config to run the service in production.

version: '3'
volumes:
  database: {}
services:
  db:
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust
    image: postgres:12.2
    volumes:
      - database:/var/lib/postgresql/data
  app:
    environment:
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - DB_TEST_HOST=${DB_TEST_HOST}
      - DB_TEST_USERNAME=${DB_TEST_USERNAME}
    image: chrztoph/texterify:${GITHUB_SHA}
    build:
      context: .
      args:
        SENTRY_SOURCE_MAPS_AUTH_TOKEN: ${SENTRY_SOURCE_MAPS_AUTH_TOKEN}
        SENTRY_SOURCE_MAPS_ORGANIZATION: ${SENTRY_SOURCE_MAPS_ORGANIZATION}
        SENTRY_SOURCE_MAPS_PROJECT: ${SENTRY_SOURCE_MAPS_PROJECT}
        COMMIT_HASH: ${GITHUB_SHA}
        PROPRIETARY_MODE: ${PROPRIETARY_MODE}
        STRIPE_PUBLIC_API_KEY: ${STRIPE_PUBLIC_API_KEY}
        TEXTERIFY_PAYMENT_SERVER: ${TEXTERIFY_PAYMENT_SERVER}
        SENTRY_DSN_FRONTEND: ${SENTRY_DSN_FRONTEND}
        RAILS_ENV_ARG: test
        NODE_ENV_ARG: production
      dockerfile: Dockerfile
    # entrypoint: ["docker-compose-test-setup.sh"]
    depends_on:
      - db
    volumes:
      - ./coverage:/var/www/texterify/coverage
